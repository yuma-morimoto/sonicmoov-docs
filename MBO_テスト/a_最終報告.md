# MBO最終報告：ナビパーク案件テスト実装

## 1. 目標概要

### 背景（As-Is）
- ナビパーク案件では長期的な開発を経て機能が複雑化しており、修正や新規実装にてデグレやバグが発生するリスクが増大している
- 現状では単体・E2Eいずれのテストコードも十分に整備されておらず、品質保証を人手の確認に依存している状況
- 法人対応では大規模な機能追加や既存部分との連携が発生するため、テスト環境の整備と自動化が必要である

### 目指す姿（To-Be）
- 法人対応フェーズでの開発と並行して、単体テストの網羅やPlaywrightを用いたE2Eテストを導入し、品質の自動検証体制を構築する
- テスト環境（ローカル / CI等）の整備を行い、DEV, STG環境の両方で安定してテストを実行できる状態を作る
- 実施過程で得た知見を整理し、他案件でも再利用可能なテスト導入ガイドとして共有する

## 2. 目標達成状況

| 小目標                        | 達成状況   | 補足                   |
| -------------------------- | ------ | -------------------- |
| アプリ側でE2Eのテストを動かす環境を構築      | ○      | 完了                   |
| 法人対応のアプリ側のE2Eテストが書けた       | 全体の20% | 一部完了（主要3画面程度）        |
| 法人対応のアプリ側の単体テストが書けた        | ○      | 完了                   |
| 法人対応のアプリ側の単体テストのカバレッジ65%達成 | ○      | 完了（現在のカバレッジ: 84.63%） |

## 3. 実施内容と成果

### 3.1 行った取り組み

#### E2E テスト環境構築
- **実施内容**：
  - Playwright を導入し、E2E テストには保守しやすいテスト基盤を作るために Page Object Model を採用した。
  - ローカル実行環境の構築と、GitHub Actions の workflow を作成した。
- **成果物**：
  - zenn記事：[E2EのPOMを関数ベースで書いてみた](https://zenn.dev/sonicmoov/articles/ec18ed5659907c)
  - GitHub Actions 上での Playwright 実行は、workflow 作成までは完了したが実行時エラーが発生しており、原因調査と修正は今後の課題。

#### 法人対応のE2Eテスト作成
- **実施内容：**
  - 主要画面のユーザーフローを対象に E2E テストを実装
  - **テスト対象画面：**
	  - 駐車場詳細画面
	  - 仮申込画面
	  - 再提出画面
  - アクセシビリティ情報を用いて要素を特定する方針を採用（css や `data-testid` による要素特定は行わず、`role`、`label`、`text` などを使用）

#### 法人対応の単体テスト作成
- **実施内容：**
  - Vitest を用いて単体テストを実装し、composables 配下のコードをカバレッジ対象としてテストの整備を行った。
  - ただし、composables 配下であってもstore 系や外部依存が強くモックコストが高いファイル、ロジックが薄くテスト優先度が低いファイルは対象外とした。
- **カバレッジ：**
	- Stmts: 84.63%
	- Branch: 93.16%
	- Funcs: 78.75%
```bash
File                              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
----------------------------------|---------|----------|---------|---------|-------------------
All files                         |   84.63 |    93.16 |   78.75 |    83.6 |                   
 composables                      |   90.44 |    95.14 |   82.75 |    89.8 |                   
  useCompareVersions.ts           |     100 |      100 |     100 |     100 |                   
  useDateCalculator.ts            |   83.33 |       50 |     100 |     100 | 6                 
  useExponentialBackoff.ts        |       0 |        0 |       0 |       0 | 6-46              
  useFormatVehicleNumber.ts       |     100 |      100 |     100 |     100 |                   
  useGeoCalculator.ts             |     100 |      100 |     100 |     100 |                   
  usePagination.ts                |       0 |        0 |       0 |       0 | 1-51              
  useParkingOpenChecker.ts        |     100 |      100 |     100 |     100 |                   
  usePathParams.ts                |   97.14 |      100 |   85.71 |   96.55 | 23                
  useTaxCalculator.ts             |     100 |      100 |     100 |     100 |                   
  useURLHandler.ts                |     100 |      100 |     100 |     100 |                   
  useUpdateChecker.ts             |     100 |      100 |     100 |     100 |                   
  useValidation.ts                |     100 |      100 |     100 |     100 |                   
 features/card/composables        |     100 |       50 |     100 |     100 |                   
  useCardBrand.ts                 |     100 |      100 |     100 |     100 |                   
  useCardFormatter.ts             |     100 |       50 |     100 |     100 | 4-8               
 features/monthly/composables     |       0 |        0 |       0 |       0 |                   
  useGenBottomSheetQueryParams.ts |       0 |      100 |       0 |       0 | 4-8               
  useGetApplicant.ts              |       0 |        0 |       0 |       0 | 8-38              
 features/parking/composables     |     100 |      100 |     100 |     100 |                   
  useParkingSelectRouter.ts       |     100 |      100 |     100 |     100 |                   
  usePriceSystemFormatter.ts      |     100 |      100 |     100 |     100 |                   
 features/yumenavi/composables    |       0 |      100 |       0 |       0 |                   
  useYumenaviIntegration.ts       |       0 |      100 |       0 |       0 | 4-25              
----------------------------------|---------|----------|---------|---------|-------------------
```


### 3.2 コンポーネントテストの見送りについて
- **判断内容：** コンポーネントテストは今回の対象としては本格実装せず、案件チーム内の合意により E2E テストを優先した。
- **判断理由：**
  - 案件チーム内で、まずはユーザーフローの品質を優先し、コンポーネントテストより E2E テストを優先する方針で合意していた。
  - あわせて、Playwright によるコンポーネントテストが有効かどうかの調査も並行して行っており、コンポーネントテストへの着手が後ろ倒しになった。
- **影響：**
  - 今回の実装範囲ではコンポーネントテストの本格導入までは至らなかった。
  - 一方で、調査を通じてフォームバリデーションにはコンポーネントテストが有効に使えそうであること、保守が容易であることが分かり、今後の課題が明確になった。

## 4. 未達項目と要因

### 4.1 未達項目

- **法人対応のアプリ側のE2Eテストが書けた**：全体の20%達成（主要3画面程度まで実装）

### 4.2 要因分析

**主な要因：**
- 実装できたE2Eテストは主要3画面程度に留まり、法人対応の全体を網羅するまでには至らなかった。
- 工数と優先度の兼ね合いから、まずは影響度の高い画面を優先して実装した。

## 5. 得られた知見・学び

- Playwright の E2E テストでは、Page Object Model と fixture を組み合わせることで、テストコードの見通しと保守性を高められることがわかった。
- MSW モックをファクトリパターンで実装することで、テストごとの差分をレスポンスの上書きに集約でき、モックの管理コストを下げられることがわかった。
- Playwright によるコンポーネントテストの活用を検討した結果、フォームバリデーションのような検証には有効そうだとわかった。
- バックエンドに接続する E2E テストは、デバッグの難しさや Flaky さが運用負荷につながりやすく、モック設計が重要だとわかった。

## 6. 課題と今後のアクション

- 単体テストカバレッジの維持・向上に向けたテスト追加
-  E2Eテストケースの拡充
- GitHub Actions 上で Playwright が失敗する原因を調査し、CI で安定実行できるように修正する
- フォームバリデーションを対象に、Playwright を用いたコンポーネントテストの有効性を継続検証し、適用方針を整理する
