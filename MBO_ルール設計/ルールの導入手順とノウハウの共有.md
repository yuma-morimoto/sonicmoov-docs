## 記事の概要
- これはコード生成のAIエージェントルール（copilot-instructions.md, CLAUDE.md）を導入する手順とノウハウの共有記事です。どの案件にも対応できるような内容にして、フロントエンドチーム内で共有する予定です。
- [参考:ルール設計](ルール設計)
## 目的
- これはルール構築を強制するものではなく、ルールをまだ書いたことがなかったり知見が少ないエンジニア向けに参考となる情報を提供するものである。
## 要件
- ここに書かれている要件は記事にMUSTで必要です。
- [ルール設計](ルール設計)に「ガイド」というセクションがあるのでそれをベースとして記事を書く。
- ルールのアンチパターン
## 記事執筆の手順

- [x] ルール設計.md の「ガイド」セクション（0〜9章）を元に記事の目次を確定する
- [x] 「はじめに」を書く — 課題感（AIコード生成でよく起きる失敗）と、このガイドで解決することを明確にする
- [x] ルール設計の考え方（概念）を書く — 「細かいルールを書けばいい」がアンチパターンである理由、ガードレールとしての位置づけ
- [x] MVP（最小ルールセット）を書く — コピペで今日から使えるテンプレと、30分で導入できる手順を中心に
- [x] ルールを増やす設計パターン集を書く — 「失敗→ルール」の対応表形式で実践的に
- [x] ルールの書き方ガイドを書く — 粒度・優先順位・分量の考え方
- [x] **ルールのアンチパターンを書く**（要件必須）
- [x] AIに渡すコンテキスト設計を書く — ルールより土台が大事という観点
- [x] 導入・運用手順を書く — ステップ、置き場所、変更管理
- [x] 効果測定の方法を書く — 5段階評価と定期メンテの基準
- [x] 付録（コピペ用テンプレ集）を整備する
- [ ] 全体を通読して推敲し、フロントエンドチーム向けのトーンに整える
- [ ] ナビパークとweaveに導入したルールのフォーマットを載せる
---

[ここから記事本文]

# AIエージェントルールの導入手順とノウハウ

| 章 | 内容 |
|----|------|
| はじめに | このガイドで解決すること |
| 1 | ルール設計の考え方（ガードレールの概念） |
| 2 | MVP最小ルールセット（コピペテンプレ＋30分手順） |
| 3 | 設計パターン集（既存実装逸脱・バグ・スタイル統一など5パターン） |
| 4 | ルールの書き方ガイド（粒度・優先順位・300行上限） |
| 5 | ルールのアンチパターン |
| 6 | AIに渡すコンテキスト設計（必須4点セット） |
| 7 | 導入・運用手順（3ステップ・置き場所・変更管理） |
| 8 | 効果測定（5段階評価・良い/悪いルールの判定・月次メンテ） |
| 付録 | コピペ用テンプレ（CLAUDE.md / 機能追加・バグ修正プロンプト） |

## はじめに — このガイドで解決すること

AIコード生成を使い始めると、こんな失敗が起きがちです。

- 既存の実装パターンを無視したコードが生成される
- プロジェクト固有のビジネスルールや用語が正しく反映されない
- スタイルやアーキテクチャの一貫性が崩れる
- レビューで毎回同じ指摘をすることになる

このガイドは、`copilot-instructions.md` や `CLAUDE.md` などの **AIエージェントルール** を使って、これらの問題を最小コストで解消するための実践的な手順書です。

**対象**: フロントエンドエンジニア（React / Next.js / Vue / Nuxt など、チーム開発）
**ゴール**: 30分でルールを導入し、コード生成の手戻りを減らす

---

## 1. ルール設計の考え方

### 「細かいルールを書けばいい」はアンチパターン

ルールを書き始めると、ついつい細かく定義したくなります。しかし実践から分かったことは、**細かすぎるルールはむしろ逆効果**であるということです。

ルールに書くべきこと：

- コードベースだけでは推測が難しい **案件固有の知識**
- このプロジェクトでの **正しさを決める基準**
- **暗黙知になっているNGパターン**

ルールに書かなくていいこと：

- AIの性能が上がれば自然に解決するもの（コーディングテクニックなど）
- コード上のコメントや JSDoc で表現できるもの

### ルール設計の目的は「ガードレール」

ルール設計の本質は、**AIが安全に実装できる範囲を定義すること**です。

- AIが自由に決めていい領域
- 人間が必ず判断すべき領域
- AIは「案を出すだけ」にとどめる領域

この3つを明確にすることが、守られるルールを作る第一歩です。

---

## 2. まず入れる「最小ルールセット（MVP）」— 今日から使える

### MVPの狙い

最初からすべてを書こうとすると挫折します。まず「これだけ入れれば事故が減る」最小セットを定義して、すぐに動かしましょう。

MVPで得られる効果：

- AIが既存実装を無視したコードを生成するケースが減る
- 毎回同じレビュー指摘をしなくて済むようになる
- プロジェクト固有の用語が正しく使われる

### MVP構成（コピペ用テンプレ）

```markdown
## プロジェクト概要

[プロジェクトの概要を1〜2文で記述]

## 使用可能なコマンド

- 型チェック: `[コマンド]`
- Lint: `[コマンド]`
- テスト: `[コマンド]`
- E2E: `[コマンド]`

## 実装のガイドライン

- 既存の実装とユーザーの要求の整合性が合わない場合は、実装前にユーザーに確認する
- [プロジェクト固有のルール1]
- [プロジェクト固有のルール2]

## ドメイン用語

このプロジェクトで一般的な意味と異なる定義で使われる用語：

- **[用語]**: [意味]（識別子: `[identifier]`）

## 技術スタック

- [フレームワーク/バージョン]
- [主要ライブラリ]

## ディレクトリ構成

[アーキテクチャの説明と主要ディレクトリの責務]
```

### 30分で入れる手順

1. プロジェクトルートに `CLAUDE.md`（または `.github/copilot-instructions.md`）を作成
2. プロジェクト概要と使用コマンドを記入（5分）
3. ドメイン用語を列挙（10分）
4. ディレクトリ構成の説明を追加（10分）
5. 1つだけ「よく起きる失敗」に対するルールを追加（5分）

最初はこれだけで十分です。使いながら育てていきましょう。

---

## 3. ルールを増やすときの設計パターン集

### パターン 1: 既存実装逸脱を防ぐ

**症状**: AIが既存の hook / API クライアント / 状態管理を使わず、独自実装を生成する
**原因**: AIがコードベース全体を把握できていない
**ルール例**:

```
実装前に必ず既存の類似実装を調査し、同じパターンに従うこと。
新しい関数やコンポーネントを作る前に、同等の既存実装がないか確認する。
```

### パターン 2: ビジネスルールの取りこぼし防止

**症状**: 仕様書やドメイン知識が反映されない実装が生成される
**原因**: AIがプロジェクト固有のルールを知らない
**ルール例**:

```
ドメイン用語集に定義された用語と識別子を使用する。
仕様の不明点は実装前にユーザーに確認する。
```

### パターン 3: バグを減らす

**症状**: null/undefined・非同期処理・境界値のハンドリングが甘いコードが生成される
**原因**: AIはハッピーパスを優先しがち
**ルール例**:

```
エラーハンドリングを必ず実装する。
非同期処理では必ずローディング・エラー・成功の3状態を考慮する。
```

### パターン 4: スタイル・設計統一

**症状**: コンポーネントの責務が混在したり、層の依存関係が崩れる
**ルール例**:

```
[アーキテクチャのルール（例: features/ 以下は機能別に分離する）]
[禁止事項（例: pages/ から API を直接呼ばない）]
```

### パターン 5: レビュー効率を上げる

**ルール例**:

```
実装後は以下を出力する：
1. 変更の概要（1〜3行）
2. 変更ファイル一覧と変更理由
3. テスト観点（何を確認すべきか）
```

---

## 4. ルールの「書き方」ガイド

### 良いルールの条件

- **1ルール = 1判断** に絞る
- **禁止 / 推奨 / 条件付き** を明確に書き分ける
- 曖昧な表現を避け、AIが迷わない具体的な指示にする
- 参照先ファイルを明記する（例: `features/auth/` を参照）

### ルールの優先順位

```
優先度: 既存実装 > コーディング規約 > 好み
```

### ルールの分量

- **300行未満を目安にする**
- コンテキストウィンドウを圧迫すると、AIの出力品質が下がる
- 具体的なコード例は書かず、抽象的に書く（コードはコードベース上に書く）

---

## 5. ルールのアンチパターン

### アンチパターン 1: ルールが長すぎる

❌ 悪い例：コンポーネントの詳細な実装手順をルールに書く
✅ 良い例：「既存の Button 実装（`components/Button.vue`）を参照する」と一言書く

コードで表現できることはコードに書く。ルールはそれを補完するもの。

### アンチパターン 2: AIの能力に依存するルール

❌ 悪い例：「パフォーマンスを最適化してください」
✅ 良い例：「`useCallback` を使うかどうかはパフォーマンス計測後に判断する」

AIの能力が上がれば不要になるルールは、価値が一時的にしかならない。

### アンチパターン 3: 一度起きただけでルール化する

❌ 悪い例：一度起きた失敗をすぐにルールに追加する
✅ 良い例：同じ問題が複数回起きたらルール化を検討する

ルールを増やすほど、コンテキストが圧迫されAIの精度が下がる。追加は慎重に。

### アンチパターン 4: コードで書けるものをルールに書く

❌ 悪い例：コンポーネントの Props の説明をルールに書く
✅ 良い例：JSDoc や TypeScript の型定義で表現する

ルールは「コードベースだけでは読み取れない情報」のみを補うもの。

### アンチパターン 5: チーム共通ルールとプロジェクト固有ルールを混在させる

❌ 悪い例：全プロジェクト共通のコーディング規約を `CLAUDE.md` に書く
✅ 良い例：プロジェクト固有の情報（ドメイン用語、アーキテクチャ）のみ書く

共通ルールはチーム共有のドキュメントに書き、プロジェクトルールから参照させる。

---

## 6. "AIに渡すコンテキスト"設計

ルールがあっても、AIに渡す **コンテキストの質** が低いと「分かってない実装」になりがちです。

### 必須コンテキストの4点セット

| # | 内容 | 例 |
|---|------|----|
| 1 | アーキテクチャ概要 | 層の責務・依存関係 |
| 2 | ディレクトリマップ | どこに何があるか |
| 3 | 主要な既存実装の参照先 | UI / 状態管理 / API / エラー処理の代表例 |
| 4 | ビジネスルールの一次情報 | ドメイン用語集・仕様書 |

仕様が散らばっている場合は、まず README または Glossary（用語集）にまとめてからルールで参照させましょう。

---

## 7. 導入・運用手順

### 導入ステップ

| ステップ | タイミング | 内容 |
|----------|------------|------|
| 1 | Day 1 | MVP（最小ルールセット）を導入 |
| 2 | Day 2-7 | 実際に使いながら「効かなかった」箇所をメモ |
| 3 | Day 8 | メモをもとにルールを追加（1〜3個ずつ） |

### ルールの置き場所

```
プロジェクトルート/
├── CLAUDE.md                          # Claude Code 用
└── .github/
    └── copilot-instructions.md        # GitHub Copilot 用
```

バージョン管理はしたくない場合：

```bash
echo -e "AGENTS.md\nCLAUDE.md\nRULES_USAGE_LOG.md" >> .git/info/exclude
```

### 変更管理

- ルールの変更は通常の PR フローで行う
- 変更理由をコメントに残す（「なぜ追加/削除したか」）
- 新規参加者が最初に読む場所として機能させる

---

## 8. ルールの効果測定

### 「効果がある」とはどういう状態か

> コード生成によって発生する、**実装の手戻りや抜け漏れ・バグを減らし**、コーディングスタイルを守り、既存実装やビジネスルールを理解した実装ができること。

### 5段階評価

| スコア | 状態 |
|--------|------|
| 5 | ルールなしでは起きていた問題がなくなった |
| 4 | 手戻りが明らかに減った |
| 3 | 効果があるか微妙（継続観察） |
| 2 | あまり変わらない |
| 1 | むしろ悪化した（ルールを見直すべき） |

### 良いルール / 悪いルールの判定基準

- **良いルール**: 適用後にレビュー指摘が減った、手戻りが減った
- **悪いルール**: AIが守らない、副作用が多い、内容が古い

### 定期メンテ（月1回）

- 守られているか？（PR の差分で確認）
- 重複・矛盾がないか？
- 削除できるルールはないか？

---

## 付録：コピペで使えるテンプレ集

### 最小ルールセット（`CLAUDE.md` / `copilot-instructions.md`）

```markdown
## プロジェクト概要

[プロジェクトの概要を1〜2文で記述]

## 使用可能なコマンド

- 型チェック: `[コマンド]`
- Lint: `[コマンド]`
- テスト: `[コマンド]`

## 実装のガイドライン

- 既存実装と要求の整合性が取れない場合は、実装前にユーザーに確認する
- [プロジェクト固有のルール1]
- [プロジェクト固有のルール2]

## ドメイン用語

- **[用語]**: [意味]（識別子: `[id]`）

## 技術スタック

- [フレームワーク/バージョン]

## ディレクトリ構成

[主要ディレクトリと責務の説明]
```

### プロンプトテンプレ（機能追加）

```
以下の機能を追加してください。

【要件】
[要件を箇条書きで記述]

【実装前に確認すること】
- 既存の類似実装を調査する
- ドメイン用語集を確認する
- 影響範囲を特定する

【実装後に出力すること】
- 変更の概要
- 変更ファイル一覧と変更理由
- テスト観点
```

### プロンプトテンプレ（バグ修正）

```
以下のバグを修正してください。

【症状】
[バグの症状を具体的に記述]

【再現手順】
[再現手順を箇条書きで記述]

【修正方針】
- 根本原因を特定してから修正する
- 関連する既存実装を確認する
- 修正範囲を最小限にする
```