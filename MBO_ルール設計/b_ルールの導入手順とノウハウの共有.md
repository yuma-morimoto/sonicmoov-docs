# ルールの導入ガイドとノウハウの共有

## この資料のレビュー観点
1. FEU で使ってもいやすいように端的にまとめられていること
2. 恒久的に活用できる資料であること

## 構成v2
- **ルールはなぜ必要なのか？**
	- ルールの要不要は案件の開発方針や規模で異なる
- **ルールテンプレート**
	- [ルールテンプレート](e_ルールテンプレート)
	- ルールの決まった構成は存在しない
	- あくまでゼロドラフトで始められるテンプレートであって、ルールの構成は自由である
- **「実装ガイドライン」について**
- **「ドメイン用語」について**
- **「ディレクトリ構成」について**
		- ディレクトリ構成とその役割を書くと場所を迷わない
- **運用 ※ここでは実際のルール運用のノウハウについて説明します**
	- **初めからルールを全部書かない、小さなルールから始める**
		- ルールは300行を基準にそれ以上の場合は簡略化を検討する
	- **具体的なコードは書かない**
		- 具体的なコードを用いたルールはコンテキストの圧迫かつ、効果があまり見込めないため特別な理由がない限り書かない方がいい
	- **コーディングスタイルの指示を書く**
		- 「関数の宣言はアロー関数を使用する」「シンタックスシュガーを意識する」などの組織固有の慣習的なルールから、「anyを使わない」「constを使う」など基本的なルールの指示を書いておく必要がある。現状のモデルでは改善されてきているがまだ完全ではない。
	- **ビジネスルールを書く**
		- ドメイン用語など案件固有の知識
		- **ルールはAIに書かせる**
			- 体裁を綺麗に整えられる
		- **ルールファイルは git 管理から除外する（example は git 管理する）**
			- 新規アサインのメンバーがすぐ使えるように `*.example` を用意し、それをベースに各自がローカルでカスタマイズする
			- 使用するモデルや環境により最適なルールが変わるため、ignore して「自由にいじってよい」状態にするのが目的
- **ルール評価ポリシーでルールを評価する**
- **ルールの自己改善はまだ難しい**
	- AI 自身にルールの自己改善をやらせるのはまだ難しい（草案は出させても、判断は人間が行う）

## 概要
- これはコード生成の AI エージェントルール（`CLAUDE.md` / `.github/copilot-instructions.md` など）を導入する手順とノウハウの共有記事です。
- どの案件にも対応できるよう、プロジェクト固有情報とテンプレを分けて運用できる構成を目指します。
- 参考: `MBO_ルール設計/ルール設計.md`


| 章    | 内容                                   |
| ---- | ------------------------------------ |
| はじめに | このガイドで解決すること                         |
| 1    | ルール設計の考え方（ガードレールの概念）                 |
| 2    | MVP最小ルールセット（コピペテンプレ＋30分手順）           |
| 3    | 設計パターン集（既存実装逸脱・バグ・スタイル統一など5パターン）     |
| 4    | ルールの書き方ガイド（粒度・優先順位・300行上限）           |
| 5    | ルールのアンチパターン（7パターン）                   |
| 6    | AIに渡すコンテキスト設計（必須4点セット）               |
| 7    | 導入・運用手順（3ステップ・置き場所・変更管理）             |
| 8    | 効果測定（5段階評価・良い/悪いルールの判定・月次メンテ）        |
| 付録   | コピペ用テンプレ（CLAUDE.md / 機能追加・バグ修正プロンプト） |

## はじめに

この記事では、去年執筆したルール設計「[【エージェントルール】 中長期開発におけるルール設計](https://zenn.dev/sonicmoov/articles/0f9e98f3539d04)」を他の案件でも活用できるように調整し、運用しやすいルール構成と運用のコツをまとめたものです。

このガイドで解決することは、効果のあるルールを書けるようになること、ルールの運用をうまくできるようになることです。

---

## 1. ルール設計の考え方

### 「細かいルールを書けばいい」はアンチパターン

ルールを書き始めると、ついつい細かく定義したくなります。しかし実践から分かったことは、**細かすぎるルールはむしろ逆効果**であるということです。

ルールに書くべきこと：

- コードベースだけでは推測が難しい **案件固有の知識**
- このプロジェクトでの **正しさを決める基準**
- **暗黙知になっているNGパターン**

ルールに書かなくていいこと：

- AIの性能が上がれば自然に解決するもの（コーディングテクニックなど）
- コード上のコメントや JSDoc で表現できるもの

> **実践メモ**: `any` 型を使わない・アロー関数を使うなどのコーディングスタイルは、現時点ではまだルールに書いておかないと守られない場合があります。「将来的には不要になる」という前提を持ちつつも、今のモデルでは書いておく方が安全です。

### ルール設計の目的は「ガードレール」

ルール設計の本質は、**AIが安全に実装できる範囲を定義すること**です。

- AIが自由に決めていい領域
- 人間が必ず判断すべき領域
- AIは「案を出すだけ」にとどめる領域

この3つを明確にすることが、守られるルールを作る第一歩です。

---

## 2. まず入れる「最小ルールセット」— 今日から使える

### MVPの狙い

最初からあれもこれも書こうとすると、不要なルールまで含まれてしまいます。ルールが多すぎるとAIのコンテキストを圧迫し、かえって精度が下がります。まずはテンプレートと案件固有の情報だけで構成した必要最小限のセットから始めて、実際に使いながら本当に必要なルールだけを追加していきましょう。

MVPで得られる効果：

- 不要なルールが含まれず、コンテキストをクリーンな状態で始められる
- 実際に使いながら「本当に必要なルール」を見極められる
- テンプレートと案件固有情報だけで構成されるため、どのプロジェクトにも適用しやすい

### MVP構成（コピペ用テンプレ）

```markdown
## プロジェクト概要

[プロジェクトの概要を1〜2文で記述]

## 使用可能なコマンド

- 型チェック: `[コマンド]`
- Lint: `[コマンド]`
- テスト: `[コマンド]`
- E2E: `[コマンド]`

## 実装のガイドライン

- 既存の実装とユーザーの要求の整合性が合わない場合は、実装前にユーザーに確認する
- [プロジェクト固有のルール1]
- [プロジェクト固有のルール2]

## ドメイン用語

このプロジェクトで一般的な意味と異なる定義で使われる用語：

- **[用語]**: [意味]（識別子: `[identifier]`）

## 技術スタック

- [フレームワーク/バージョン]
- [主要ライブラリ]

## ディレクトリ構成

[アーキテクチャの説明と主要ディレクトリの責務]
```

### 30分で入れる手順

1. プロジェクトルートに `CLAUDE.md`（または `.github/copilot-instructions.md`）を作成
2. プロジェクト概要と使用コマンドを記入（5分）
3. ドメイン用語を列挙（10分）
4. ディレクトリ構成の説明を追加（10分）
5. 1つだけ「よく起きる失敗」に対するルールを追加（5分）

最初はこれだけで十分です。使いながら育てていきましょう。

> **実践メモ**: ルールはAIに書かせると構造的に整理されて読みやすくなります。「このプロジェクトのルールを整理して `CLAUDE.md` の形式で出力して」と依頼するのが手軽でおすすめです。

---

## 3. ルールを増やすときの設計パターン集

### パターン 1: 既存実装逸脱を防ぐ

**症状**: AIが既存の hook / API クライアント / 状態管理を使わず、独自実装を生成する
**原因**: AIがコードベース全体を把握できていない
**ルール例**:

```
実装前に必ず既存の類似実装を調査し、同じパターンに従うこと。
新しい関数やコンポーネントを作る前に、同等の既存実装がないか確認する。
```

### パターン 2: ビジネスルールの取りこぼし防止

**症状**: 仕様書やドメイン知識が反映されない実装が生成される
**原因**: AIがプロジェクト固有のルールを知らない
**ルール例**:

```
ドメイン用語集に定義された用語と識別子を使用する。
仕様の不明点は実装前にユーザーに確認する。
```

### パターン 3: バグを減らす

**症状**: null/undefined・非同期処理・境界値のハンドリングが甘いコードが生成される
**原因**: AIはハッピーパスを優先しがち
**ルール例**:

```
エラーハンドリングを必ず実装する。
非同期処理では必ずローディング・エラー・成功の3状態を考慮する。
```

### パターン 4: スタイル・設計統一

**症状**: コンポーネントの責務が混在したり、層の依存関係が崩れる
**ルール例**:

```
[アーキテクチャのルール（例: features/ 以下は機能別に分離する）]
[禁止事項（例: pages/ から API を直接呼ばない）]
```

### パターン 5: レビュー効率を上げる

**ルール例**:

```
実装後は以下を出力する：
1. 変更の概要（1〜3行）
2. 変更ファイル一覧と変更理由
3. テスト観点（何を確認すべきか）
```

---

## 4. ルールの「書き方」ガイド

### 良いルールの条件

- **1ルール = 1判断** に絞る
- **禁止 / 推奨 / 条件付き** を明確に書き分ける
- 曖昧な表現を避け、AIが迷わない具体的な指示にする
- 参照先ファイルを明記する（例: `features/auth/` を参照）

### ルールの優先順位

```
優先度: 既存実装 > コーディング規約 > 好み
```

### ルールの分量

- **300行未満を目安にする**
- コンテキストウィンドウを圧迫すると、AIの出力品質が下がる
- 具体的なコード例は書かず、抽象的に書く（コードはコードベース上に書く）

---

## 5. ルールのアンチパターン

### アンチパターン 1: ルールが長すぎる

❌ 悪い例：コンポーネントの詳細な実装手順をルールに書く
✅ 良い例：「既存の Button 実装（`components/Button.vue`）を参照する」と一言書く

コードで表現できることはコードに書く。ルールはそれを補完するもの。

### アンチパターン 2: AIの能力に依存するルール

❌ 悪い例：「パフォーマンスを最適化してください」
✅ 良い例：「`useCallback` を使うかどうかはパフォーマンス計測後に判断する」

AIの能力が上がれば不要になるルールは、価値が一時的にしかならない。

### アンチパターン 3: 一度起きただけでルール化する

❌ 悪い例：一度起きた失敗をすぐにルールに追加する
✅ 良い例：同じ問題が複数回起きたらルール化を検討する

ルールを増やすほど、コンテキストが圧迫されAIの精度が下がる。追加は慎重に。

### アンチパターン 4: コードで書けるものをルールに書く

❌ 悪い例：コンポーネントの Props の説明をルールに書く
✅ 良い例：JSDoc や TypeScript の型定義で表現する

ルールは「コードベースだけでは読み取れない情報」のみを補うもの。

### アンチパターン 5: チーム共通ルールとプロジェクト固有ルールを混在させる

❌ 悪い例：全プロジェクト共通のコーディング規約を `CLAUDE.md` に書く
✅ 良い例：プロジェクト固有の情報（ドメイン用語、アーキテクチャ）のみ書く

共通ルールはチーム共有のドキュメントに書き、プロジェクトルールから参照させる。

### アンチパターン 6: 強制指示（絶対厳守）を多用する

❌ 悪い例：重要でないルールにも「必ず」「絶対に」「厳守」と書く
✅ 良い例：本当に守らせたいルールだけに強い表現を使い、他は「推奨」にとどめる

強制指示が多すぎると、AIがどれを優先すべきか判断できなくなり、結果的にどれも守られなくなります。重要度のメリハリが大切です。

### アンチパターン 7: AIにルールを自己改善させる

❌ 悪い例：「実装後に必要なルールを自分でルールファイルに追記して」と指示する
✅ 良い例：人間がルールの追加・削除を判断し、AIは草案を出すだけにする

AIは自分の実装がどれくらい正確だったかを正しく評価できないため、的外れなルールを追加してしまうことがあります。ルールの改善は人間が主導してください。

---

## 6. "AIに渡すコンテキスト"設計

ルールがあっても、AIに渡す **コンテキストの質** が低いと「分かってない実装」になりがちです。

### 必須コンテキストの4点セット

| # | 内容 | 例 |
|---|------|----|
| 1 | アーキテクチャ概要 | 層の責務・依存関係 |
| 2 | ディレクトリマップ | どこに何があるか |
| 3 | 主要な既存実装の参照先 | UI / 状態管理 / API / エラー処理の代表例 |
| 4 | ビジネスルールの一次情報 | ドメイン用語集・仕様書 |

仕様が散らばっている場合は、まず README または Glossary（用語集）にまとめてからルールで参照させましょう。

---

## 7. 導入・運用手順

### 導入ステップ

| ステップ | タイミング | 内容 |
|----------|------------|------|
| 1 | Day 1 | MVP（最小ルールセット）を導入 |
| 2 | Day 2-7 | 実際に使いながら「効かなかった」箇所をメモ |
| 3 | Day 8 | メモをもとにルールを追加（1〜3個ずつ） |

### ルールの置き場所

```
プロジェクトルート/
├── CLAUDE.md                          # Claude Code 用（ローカルでカスタマイズする）
├── CLAUDE.md.example                  # 例（git 管理する）
└── .github/
    ├── copilot-instructions.md        # GitHub Copilot 用（ローカルでカスタマイズする）
    └── copilot-instructions.md.example # 例（git 管理する）
```

ルールは使用するモデルや環境によって最適解が変わるため、実ファイル（`CLAUDE.md` / `.github/copilot-instructions.md`）は git 管理から除外し、各自がローカルでカスタマイズできるようにします。
一方で、新規アサインのメンバーがすぐ始められるように、example（`*.example`）を git 管理し、PR で更新していく運用にします（`.env.example` に近い考え方）。

### ignore 設定（チーム共通）

実ファイルは git 管理から除外し、example は追跡対象にします。

例（`.gitignore` に追記する場合）：

```gitignore
CLAUDE.md
.github/copilot-instructions.md
RULES_USAGE_LOG.md
```

リポジトリを汚したくない場合は、ローカルだけで除外する方法もあります（`.git/info/exclude` など）。

### ローカルでの初期化

example をコピーして、自分の環境に合わせて調整します。

```bash
cp CLAUDE.md.example CLAUDE.md
cp .github/copilot-instructions.md.example .github/copilot-instructions.md
```

### 変更管理

- example（`*.example`）の変更は通常の PR フローで行う
- 変更理由をコメントに残す（「なぜ追加/削除したか」）
- 新規参加者が最初に読む場所として機能させる

---

## 8. ルールの効果測定

### 「効果がある」とはどういう状態か

> コード生成によって発生する、**実装の手戻りや抜け漏れ・バグを減らし**、コーディングスタイルを守り、既存実装やビジネスルールを理解した実装ができること。

### 5段階評価

| スコア | 状態 |
|--------|------|
| 5 | ルールなしでは起きていた問題がなくなった |
| 4 | 手戻りが明らかに減った |
| 3 | 効果があるか微妙（継続観察） |
| 2 | あまり変わらない |
| 1 | むしろ悪化した（ルールを見直すべき） |

### 良いルール / 悪いルールの判定基準

- **良いルール**: 適用後にレビュー指摘が減った、手戻りが減った
- **悪いルール**: AIが守らない、副作用が多い、内容が古い

### 定期メンテ（月1回）

- 守られているか？（PR の差分で確認）
- 重複・矛盾がないか？
- 削除できるルールはないか？

---

## 付録：コピペで使えるテンプレ集

### 最小ルールセット（`CLAUDE.md` / `copilot-instructions.md`）

```markdown
## プロジェクト概要

[プロジェクトの概要を1〜2文で記述]

## 使用可能なコマンド

- 型チェック: `[コマンド]`
- Lint: `[コマンド]`
- テスト: `[コマンド]`

## 実装のガイドライン

- 既存実装と要求の整合性が取れない場合は、実装前にユーザーに確認する
- [プロジェクト固有のルール1]
- [プロジェクト固有のルール2]

## ドメイン用語

- **[用語]**: [意味]（識別子: `[id]`）

## 技術スタック

- [フレームワーク/バージョン]

## ディレクトリ構成

[主要ディレクトリと責務の説明]
```

### プロンプトテンプレ（機能追加）

```
以下の機能を追加してください。

【要件】
[要件を箇条書きで記述]

【実装前に確認すること】
- 既存の類似実装を調査する
- ドメイン用語集を確認する
- 影響範囲を特定する

【実装後に出力すること】
- 変更の概要
- 変更ファイル一覧と変更理由
- テスト観点
```

### プロンプトテンプレ（バグ修正）

```
以下のバグを修正してください。

【症状】
[バグの症状を具体的に記述]

【再現手順】
[再現手順を箇条書きで記述]

【修正方針】
- 根本原因を特定してから修正する
- 関連する既存実装を確認する
- 修正範囲を最小限にする
```

---

## 編集者向けメモ（任意）

### この資料の目的
- これはルール構築を強制するものではなく、ルールをまだ書いたことがなかったり知見が少ないエンジニア向けに参考となる情報を提供するものです。

### 要件（執筆時）
- `MBO_ルール設計/ルール設計.md` に「ガイド」というセクションがあるので、それをベースとして記事を書く。
- ルールのアンチパターンは必須で含める。

### 記事執筆の手順（作業メモ）
- [x] ルール設計.md の「ガイド」セクション（0〜9章）を元に記事の目次を確定する
- [x] 「はじめに」を書く（課題感と、このガイドで解決することを明確にする）
- [x] ルール設計の考え方（概念）を書く
- [x] MVP（最小ルールセット）を書く（コピペテンプレと、30分で導入できる手順）
- [x] ルールを増やす設計パターン集を書く（「失敗→ルール」の対応表形式）
- [x] ルールの書き方ガイドを書く（粒度・優先順位・分量）
- [x] ルールのアンチパターンを書く（要件必須）
- [x] AI に渡すコンテキスト設計を書く
- [x] 導入・運用手順を書く（置き場所、変更管理）
- [x] 効果測定の方法を書く（5段階評価、定期メンテ）
- [x] 付録（コピペ用テンプレ集）を整備する
- [ ] 全体を通読して推敲し、フロントエンドチーム向けのトーンに整える
- [ ] ナビパークと weave に導入したルールのフォーマットを載せる
